/**
 * Live poll main module.
 *
 * @copyright Copyright (c) 2018 Open LMS
 * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_livepoll/livepoll-lazy",["jquery","core/log","core/templates"],(function($,Log,templates){var self=this,resetVotes=function(){self.votes=[],$.each(self.options,(function(optionid){self.votes[optionid]=0}))},addClickListeners=function(){self.listeningToClicks||($(".livepoll-votebtn").on("click",(function(){var vote={option:$(this).data("option")},voteRef=self.database.ref("polls/"+self.pollKey+"/votes/"+self.userKey);voteRef.once("value").then((function(voteSnapshot){voteSnapshot.val()&&voteSnapshot.val().option===vote.option?voteRef.remove():voteRef.set(vote)}))})),self.listeningToClicks=!0)},updateVoteUI=function(){var promises=[];$.each(self.resultHandlers,(function(i,handler){var promise=handler.update(self.options,self.votes);promises.push(promise)})),$.when.apply($,promises).done((function(){Log.debug("livepoll UI has been updated.")}))},updateVoteCount=function(){self.database.ref("polls/"+self.pollKey+"/votes").once("value").then((function(votesSnapshot){var votes=votesSnapshot.val();resetVotes(),$(".livepoll-votebtn").addClass("btn-primary").removeClass("btn-success"),$.each(votes,(function(userKey,vote){self.votes[vote.option]++,userKey===self.userKey&&$('.livepoll-votebtn[data-option="'+vote.option+'"]').addClass("btn-success").removeClass("btn-primary")})),updateVoteUI()}))},updateControls=function(){self.database.ref("polls/"+self.pollKey+"/controls").once("value").then((function(controlsSnapshot){var controlStatus=controlsSnapshot.val();if(self.closeVoting=!!controlStatus.closeVoting,self.higlightAnswer=!!controlStatus.higlightAnswer,$("#livepoll_closevoting").prop("checked",self.closeVoting),$("#livepoll_highlightanswer").prop("checked",self.higlightAnswer),$(".livepoll-votebtn").toggleClass("disabled",self.closeVoting),self.closeVoting){self.listeningToClicks&&($(".livepoll-votebtn").off("click"),self.listeningToClicks=!1);0===$(".livepoll-closed-voting-msg > .alert").length&&templates.render("mod_livepoll/voting_closed",{}).then((function(html,js){templates.appendNodeContents(".livepoll-closed-voting-msg",html,js),$(".livepoll-closed-voting-msg > .alert").alert().removeClass("hide").addClass("show")}))}else addClickListeners(),$(".livepoll-closed-voting-msg > .alert").length>0&&$(".livepoll-closed-voting-msg > .alert").alert("close");$(".livepoll-votebtn").removeClass("livepoll-answer-animation"),$(".mod-livepoll-text-result").removeClass("livepoll-answer-animation"),self.higlightAnswer&&($('.livepoll-votebtn[data-option="'+self.correctOption+'"]').addClass("livepoll-answer-animation"),$(".mod-livepoll-text-result:has(#vote-count-"+self.correctOption+")").addClass("livepoll-answer-animation"))}))},initFirebase=function(){var config={apiKey:self.apiKey,authDomain:self.authDomain,databaseURL:self.databaseURL,projectId:self.projectID};self.firebase.initializeApp(config),self.database=self.firebase.database(),self.auth=self.firebase.auth(),self.auth.signInAnonymously().catch((function(error){var errorCode=error.code,errorMessage=error.message;Log.error("Could not authenticate into firebase using anonymous setup."),Log.error(errorCode),Log.error(errorMessage)})),self.auth.onAuthStateChanged((function(user){user?(Log.debug("User has signed in to firebase."),self.fbuser=user,function(){var dfd=$.Deferred(),subPromises=[];self.resultHandlers=[];var textDecorators=["green","bold","shadowy"];return $.each(self.resultsToRender,(function(i,rType){var reqDfd=$.Deferred();require(["mod_livepoll/"+rType+"-result-lazy"],(function(Handler){if("text"===rType){var currentTxtResult=new Handler,txtPromises=[];$.each(textDecorators,(function(i,decoratorId){var txtDfd=$.Deferred();txtPromises.push(txtDfd.promise()),require(["mod_livepoll/"+decoratorId+"-text-result-lazy"],(function(TextDecorator){currentTxtResult=new TextDecorator(currentTxtResult),txtDfd.resolve()}))})),$.when.apply($,txtPromises).done((function(){self.resultHandlers.push(currentTxtResult),reqDfd.resolve()}))}else self.resultHandlers.push(new Handler),reqDfd.resolve()})),subPromises.push(reqDfd.promise())})),$.when.apply($,subPromises).done((function(){dfd.resolve()})),dfd.promise()}().done((function(){!function(){var votesRef=self.database.ref("polls/"+self.pollKey+"/votes");votesRef.on("child_added",updateVoteCount),votesRef.on("child_changed",updateVoteCount),votesRef.on("child_removed",updateVoteCount);var controlsRef=self.database.ref("polls/"+self.pollKey+"/controls");controlsRef.on("child_added",updateControls),controlsRef.on("child_changed",updateControls),controlsRef.on("child_removed",updateControls),updateVoteUI()}(),$("#livepoll_closevoting").on("change",(function(){var closeVoting=this.checked;self.database.ref("polls/"+self.pollKey+"/controls/closeVoting").set(closeVoting)})),$("#livepoll_highlightanswer").on("change",(function(){var higlightAnswer=this.checked;self.database.ref("polls/"+self.pollKey+"/controls/higlightAnswer").set(higlightAnswer)})),self.closeVoting||($(".livepoll-votebtn").removeClass("disabled"),addClickListeners())}))):Log.debug("User has signed out from firebase.")}))};return{init:function(apiKey,authDomain,databaseURL,projectID,pollKey,userKey,options,correctOption,resultsToRender){self.apiKey=apiKey,self.authDomain=authDomain,self.databaseURL=databaseURL,self.projectID=projectID,self.options=options,self.correctOption=correctOption,self.pollKey=pollKey,self.userKey=userKey,self.resultsToRender=resultsToRender,self.closeVoting=!1,self.higlightAnswer=!1,self.listeningToClicks=!1,resetVotes(),$(document).ready((function(){void 0!==firebase?(self.firebase=firebase,initFirebase()):Log.error("Firebase not found. Live poll will not work.")}))}}}));

//# sourceMappingURL=livepoll-lazy.min.js.map
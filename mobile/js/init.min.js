class AddonModLivePoll{constructor(){this.optionCtrl=null}init(t){this.intro=t.intro,this.apiKey=t.apiKey,this.authDomain=t.authDomain,this.databaseURL=t.databaseURL,this.projectID=t.projectID,this.correctOption=t.correctOption,this.options=t.options,this.optionCtrl=new OptionCtrl(this.options,this.correctOption),this.pollKey=t.pollKey,this.userKey=t.userKey,this.resultsToRender=t.resultsToRender,this.votingClosed=!1,this.firebase&&this.firebase.delete(),this.elementReady("#livepoll").then(()=>{this.initFirebase()})}doCleanup(){this.firebase.delete(),this.firebase=null}initFirebase(){var t={apiKey:this.apiKey,authDomain:this.authDomain,databaseURL:this.databaseURL,projectId:this.projectID};this.firebase=window.firebase.initializeApp(t),this.database=this.firebase.database(),this.auth=this.firebase.auth(),this.auth.signInAnonymously().catch(function(t){t.code,t.message}),this.auth.onAuthStateChanged(t=>{t&&(this.fbuser=t,this.initVoteUI(),this.addDBListeners())})}initVoteUI(){this.resultsToRender.forEach(t=>{"text"!==t&&(this.optionCtrl.chartCtrl=new ChartCtrl(t))})}addDBListeners(){var t=this.database.ref("polls/"+this.pollKey+"/votes"),t=(t.on("child_added",()=>{this.updateVoteCount()}),t.on("child_changed",()=>{this.updateVoteCount()}),t.on("child_removed",()=>{this.updateVoteCount()}),this.database.ref("polls/"+this.pollKey+"/controls"));t.on("child_added",()=>{this.updateControls()}),t.on("child_changed",()=>{this.updateControls()}),t.on("child_removed",()=>{this.updateControls()})}updateVoteCount(){this.database.ref("polls/"+this.pollKey+"/votes").once("value").then(t=>{this.optionCtrl.updateVotes(t,this.userKey)})}updateControls(){this.database.ref("polls/"+this.pollKey+"/controls").once("value").then(t=>{t=t.val();this.optionCtrl.votingClosed=!!t.closeVoting,this.optionCtrl.doHiglightAnswer(!!t.higlightAnswer)})}doVote(e){var o,i;this.optionCtrl.votingClosed||(o={option:e.optionId},(i=this.database.ref("polls/"+this.pollKey+"/votes/"+this.userKey)).once("value").then(function(t){t.val()&&t.val().option===e.option?i.remove():i.set(o)}),this.optionCtrl.updateOwnVoteInfo(e))}toggleCloseVoting(t){this.database.ref("polls/"+this.pollKey+"/controls/closeVoting").set(t?1:0)}toggleHighlight(t){this.database.ref("polls/"+this.pollKey+"/controls/higlightAnswer").set(t?1:0)}elementReady(i){return new Promise(o=>{var t=document.querySelector(i);t?o(t):new MutationObserver((t,e)=>{Array.from(document.querySelectorAll(i)).forEach(t=>{o(t),e.disconnect()})}).observe(document.documentElement,{childList:!0,subtree:!0})})}}const result={AddonModLivePoll:new AddonModLivePoll};result;